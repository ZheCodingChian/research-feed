<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ display_title if display_title else ('Papers - ' + date) }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- KaTeX CSS for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstbeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"></script>
    <style>
        body {
            background-color: #0f1011;
            color: #e0e0e0;
        }
        
        .full-width-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding-top: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .header-title-section {
            text-align: center;
            margin-bottom: 0;
            padding-bottom: 2rem;
        }
        
        .controls-section {
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 1rem 0;
            margin-top: 0;
        }
        
        .paper-card {
            margin-bottom: 1.5rem;
            border: 1px solid #404040;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            background-color: #191a1b;
        }
        
        .paper-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        .paper-header {
            padding: 1rem;
            border-bottom: 1px solid #404040;
            border-radius: 8px 8px 0 0;
            background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);
            color: #ffffff;
        }
        
        .paper-title {
            color: #ffffff;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .paper-meta {
            color: #e0e0e0;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .paper-body {
            padding: 1rem;
            background-color: #191a1b;
        }
        
        .paper-abstract {
            margin-bottom: 1rem;
            color: #d0d0d0;
        }
        
        .paper-categories {
            margin-bottom: 1rem;
        }
        
        .category-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem;
            background-color: #404040;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #e0e0e0;
        }
        
        .paper-scores-row {
            margin: 20px 0;
            text-align: left;
        }
        
        .score-tag {
            display: inline-block;
            padding: 0.4rem 0.6rem;
            margin: 0.25rem;
            background-color: #404040;
            border-radius: 4px;
            font-size: 1rem;
            color: #e0e0e0;
            font-weight: bold;
        }
        
        .score-tag.overall {
            background-color: #007bff;
            color: white;
        }
        
        /* Responsive: Stack scores on mobile */
        @media (max-width: 768px) {
            .paper-scores-row {
                font-size: 12px;
                line-height: 1.4;
                text-align: left;
            }
        }
        
        .similarity-scores {
            flex: 1;
        }
        
        .similarity-summary {
            background-color: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .similarity-scores-content {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            align-items: center;
        }
        
        .similarity-label {
            font-weight: 600;
            color: #e0e0e0;
            white-space: nowrap;
        }
        
        .similarity-right-column {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .similarity-bar {
            height: 8px;
            background-color: #404040;
            border-radius: 4px;
            overflow: hidden;
            width: 100px;
            flex-shrink: 0;
        }
        
        .similarity-value {
            color: #e0e0e0;
            font-weight: 600;
            min-width: 45px;
            flex-shrink: 0;
        }
        
        .similarity-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .paper-link {
            color: #ffffff;
            text-decoration: none;
        }
        
        .paper-link:hover {
            text-decoration: underline;
            color: #f0f0f0;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-select, .form-control {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: #ffffff;
        }
        
        .form-select option {
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .form-select:focus, .form-control:focus {
            background-color: rgba(255,255,255,0.2);
            border-color: #667eea;
            color: #ffffff;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-outline-light {
            border-color: rgba(255,255,255,0.5);
        }
        
        .btn-outline-light:hover {
            background-color: rgba(255,255,255,0.2);
            border-color: #ffffff;
        }
        
        .filter-count-section {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .filter-count-display {
            font-size: 1.2rem;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .main-nav-link {
            color: #ffffff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 1rem;
            background: linear-gradient(135deg, #2D3748 0%, #4A5568 100%);
            border: 1px solid #404040;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-nav-link:hover {
            background: linear-gradient(135deg, #4A5568 0%, #2D3748 100%);
            text-decoration: none;
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        .paper-number {
            font-weight: bold;
            color: #ffffff;
            margin-right: 0.5rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        .paper-metrics-row {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }
        
        .similarity-scores {
            flex: 1;
            min-width: 0;
        }
        
        .llm-validation {
            flex: 1;
            min-width: 0;
        }
        
        .h-index-scores {
            flex: 1;
            min-width: 0;
        }
        
        .h-index-summary {
            background-color: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .h-index-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .h-index-metric:last-child {
            margin-bottom: 0;
        }
        
        .h-index-label {
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .h-index-value {
            color: #ffffff;
            font-weight: bold;
        }
        
        .h-index-expand {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .h-index-toggle {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
        }
        
        .h-index-details {
            background-color: rgba(255,255,255,0.03);
            border-radius: 4px;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .individual-h-index {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        .individual-h-index:last-child {
            margin-bottom: 0;
        }
        
        .author-name {
            color: #e0e0e0;
        }
        
        .author-name-link {
            color: #00d4aa;
            text-decoration: none;
        }
        
        .author-name-link:hover {
            color: #00ffcc;
            text-decoration: underline;
        }
        
        .author-h-value {
            color: #ffffff;
            font-weight: 600;
        }
        
        .paper-verification {
            text-align: center;
        }
        
        .paper-verification-link {
            color: #ffd700;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .paper-verification-link:hover {
            color: #ffed4e;
            text-decoration: underline;
        }
        
        .llm-validation-summary {
            background-color: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .llm-validation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .llm-validation-item:last-child {
            margin-bottom: 0;
        }
        
        .llm-topic-label {
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .llm-status {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .llm-yes {
            color: #28a745;
        }
        
        .llm-no {
            color: #dc3545;
        }
        
        .llm-disabled {
            color: #6c757d;
        }
        
        .llm-buttons-row {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        

        
        .llm-toggle {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
        }
        
        .llm-details {
            background-color: rgba(255,255,255,0.03);
            border-radius: 4px;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .llm-justification {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .llm-justification:last-child {
            margin-bottom: 0;
        }
        
        /* New styles for topic toggles and separators */
        .similarity-toggle-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 0.5rem;
        }
        
        .similarity-toggle,
        .llm-validation-toggle,
        .similarity-normalize-toggle {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Normalized similarity scores styling */
        .similarity-summary.normalized {
            background: linear-gradient(135deg, #cc5500 0%, #b8460e 100%);
            color: #ffffff;
            border: 2px solid #cc5500;
            box-shadow: 0 2px 8px rgba(204, 85, 0, 0.4);
        }
        
        .similarity-summary.normalized .similarity-label {
            color: #ffffff;
            font-weight: 600;
        }
        
        .similarity-summary.normalized .similarity-value {
            color: #ffffff;
            font-weight: bold;
        }
        
        .similarity-summary.normalized .similarity-bar {
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .similarity-summary.normalized .similarity-bar-fill {
            background: linear-gradient(90deg, #ffcc80 0%, #ff9800 100%);
        }
        
        .similarity-summary.normalized .topic-separator {
            border-color: #ffcc80;
            margin: 1rem 0;
            border-top-width: 2px;
        }
        
        .similarity-normalize-toggle.active {
            background: linear-gradient(135deg, #ff9800 0%, #ffcc80 100%);
            color: #1a1a1a;
            border-color: #ff9800;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.4);
        }
        
        .similarity-normalize-toggle.active:hover {
            background: linear-gradient(135deg, #ffcc80 0%, #ff9800 100%);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(255, 152, 0, 0.5);
        }
        
        .topic-separator {
            margin: 0.75rem 0;
            border-top: 2px solid rgba(255,255,255,0.2);
        }
        
        @media (max-width: 768px) {
            .paper-metrics-row {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="full-width-header">
        <div class="container">
            <div style="position: absolute; top: 1rem; left: 1rem;">
                <a href="index.html" class="main-nav-link">‚Üê Back to Home</a>
            </div>
            <div class="header-title-section">
                <h1 class="mb-3">{{ display_title if display_title else ('arXiv Newsletter - ' + date) }}</h1>
                {% if is_test_mode %}
                <p class="lead mb-2">Test Mode - Specific Papers Analysis</p>
                <p class="text-muted mb-2">{{ date_range_info if date_range_info else 'Various dates' }}</p>
                {% else %}
                <p class="lead mb-2">Research Papers with Similarity Scores</p>
                <p class="text-muted mb-2">{{ date_range_info if date_range_info else ('Submitted on ' + date) }}</p>
                {% endif %}
                <p class="text-muted mb-0" id="paper-count">{{ paper_count }} papers</p>
                {% if models_used %}
                <div class="models-info mt-2">
                    <small class="text-muted">
                        <strong>Models:</strong> 
                        Embedding: <span class="badge bg-secondary">{{ models_used.embedding }}</span>
                        {% if models_used.llm != 'unknown' %}
                        | LLM Validation: <span class="badge bg-secondary">{{ models_used.llm }}</span>
                        {% endif %}
                        {% if models_used.scoring != 'unknown' %}
                        | LLM Scoring: <span class="badge bg-secondary">{{ models_used.scoring }}</span>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="controls-section">
            <div class="container">
                <div class="controls">
                    <div class="control-group">
                        <label for="sortBy" class="form-label mb-0">Sort by:</label>
                        <select id="sortBy" class="form-select form-select-sm">
                            <option value="overall_score_desc">Overall Score (Descending)</option>
                            <option value="overall_score_asc">Overall Score (Ascending)</option>
                            <option value="similarity_desc">Similarity score (Descending)</option>
                            <option value="similarity_asc">Similarity score (Ascending)</option>
                            <option value="title">Title</option>
                            <option value="arxiv_id">arXiv ID</option>
                            <option value="max_h_index_desc">Max H-index (Descending)</option>
                            <option value="max_h_index_asc">Max H-index (Ascending)</option>
                            <option value="avg_h_index_desc">Avg H-index (Descending)</option>
                            <option value="avg_h_index_asc">Avg H-index (Ascending)</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="form-label mb-0">Filter by topics:</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            {% for topic in topics %}
                            <label class="form-check-label" style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="checkbox" class="form-check-input topic-checkbox" value="{{ topic }}" style="margin: 0;">
                                <span style="font-size: 0.9rem; white-space: nowrap;">{{ topic.replace('_', ' ') }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="form-label mb-0">LLM Validation:</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label class="form-check-label" style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="checkbox" class="form-check-input llm-filter-checkbox" value="yes" style="margin: 0;">
                                <span style="font-size: 0.9rem; white-space: nowrap;">Show YES</span>
                            </label>
                            <label class="form-check-label" style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="checkbox" class="form-check-input llm-filter-checkbox" value="no" style="margin: 0;">
                                <span style="font-size: 0.9rem; white-space: nowrap;">Show NO</span>
                            </label>
                            <label class="form-check-label" style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="checkbox" class="form-check-input llm-filter-checkbox" value="not_validated" style="margin: 0;">
                                <span style="font-size: 0.9rem; white-space: nowrap;">Show Not Validated</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label class="form-label mb-0">H-Index Data:</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label class="form-check-label" style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="checkbox" class="form-check-input h-index-filter-checkbox" value="full" style="margin: 0;">
                                <span style="font-size: 0.9rem; white-space: nowrap;">Full H-index</span>
                            </label>
                            <label class="form-check-label" style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="checkbox" class="form-check-input h-index-filter-checkbox" value="partial" style="margin: 0;">
                                <span style="font-size: 0.9rem; white-space: nowrap;">Partial H-index</span>
                            </label>
                            <label class="form-check-label" style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                <input type="checkbox" class="form-check-input h-index-filter-checkbox" value="none" style="margin: 0;">
                                <span style="font-size: 0.9rem; white-space: nowrap;">No H-index</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="minScore" class="form-label mb-0">Min Score:</label>
                        <input type="number" id="minScore" class="form-control form-control-sm" 
                               step="0.01" min="0" max="1" value="0" style="width: 80px;">
                    </div>
                    
                    <div class="control-group">
                        <label for="maxScore" class="form-label mb-0">Max Score:</label>
                        <input type="number" id="maxScore" class="form-control form-control-sm" 
                               step="0.01" min="0" max="1" value="1" style="width: 80px;">
                    </div>
                    
                    <button id="resetFilters" class="btn btn-outline-light btn-sm">Reset</button>
                </div>
                
                <div class="filter-count-section">
                    <span id="filter-count" class="filter-count-display">
                        Showing {{ paper_count }}/{{ paper_count }} papers
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="papers-container">
            {% for paper in papers %}
            <div class="paper-card" data-paper-index="{{ loop.index0 }}">
                <div class="paper-header">
                    <div class="paper-number">#{{ loop.index }}</div>
                    <h5 class="paper-title">
                        <a href="{{ paper.get('arxiv_url', '#') }}" class="paper-link" target="_blank">
                            {{ paper.title }}
                        </a>
                    </h5>
                    <div class="paper-meta">
                        <strong>arXiv ID:</strong> {{ paper.get('arxiv_id', 'N/A') }} |
                        <strong>Published:</strong> {{ paper.get('published', 'N/A')[:10] }} |
                        <strong>Highest Score:</strong> {{ "%.3f"|format(paper.get('highest_score', 0)) }}{% if paper.get('highest_score_topic') %} {{ paper.highest_score_topic.replace('_', ' ') }}{% endif %}
                    </div>
                </div>
                
                <div class="paper-body">
                    <div class="paper-abstract">
                        <strong>Abstract:</strong> {{ paper.abstract }}
                    </div>
                    
                    <div class="paper-categories">
                        <strong>Categories:</strong>
                        {% for category in paper.get('categories', []) %}
                        <span class="category-tag">{{ category }}</span>
                        {% endfor %}
                    </div>
                    
                    {% if paper.get('scores_data') and paper.scores_data.get('overall_priority', 0) > 0 %}
                    <div class="paper-scores-row">
                        <span class="score-tag overall">Overall Score: {{ "%.1f"|format(paper.scores_data.overall_priority) }}/10</span>
                        <span class="score-tag">Relevance: {{ "%.1f"|format(paper.scores_data.relevance) }}/10</span>
                        <span class="score-tag">Novelty: {{ "%.1f"|format(paper.scores_data.novelty) }}/10</span>
                        <span class="score-tag">Clarity: {{ "%.1f"|format(paper.scores_data.clarity) }}/10</span>
                        <span class="score-tag">Potential Impact: {{ "%.1f"|format(paper.scores_data.potential_impact) }}/10</span>
                    </div>
                    {% endif %}
                    
                    <div class="paper-metrics-row">
                        <div class="similarity-scores">
                            <h6>Similarity Scores:</h6>
                            {% if paper.get('scores') %}
                                <div class="similarity-summary">
                                    <div class="similarity-scores-content">
                                        {% for topic, score in paper.scores.items() %}
                                        <span class="similarity-label" data-topic="{{ topic }}">{{ topic.replace('_', ' ') }}:</span>
                                        <div class="similarity-right-column" data-topic="{{ topic }}">
                                            <div class="similarity-bar">
                                                <div class="similarity-bar-fill" style="width: {{ (score * 100)|round(1) }}%"></div>
                                            </div>
                                            <span class="similarity-value" data-original-score="{{ "%.3f"|format(score) }}">{{ "%.3f"|format(score) }}</span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="similarity-toggle-section">
                                        <button class="btn btn-sm btn-outline-light similarity-toggle" 
                                                onclick="toggleSimilarityDetails(this)" 
                                                data-paper-index="{{ loop.index0 }}">
                                            Show other topics ‚ñº
                                        </button>
                                        <button class="btn btn-sm btn-outline-light similarity-normalize-toggle" 
                                                onclick="toggleNormalizedScores(this)" 
                                                data-mode="raw"
                                                data-paper-index="{{ loop.index0 }}">
                                            Show normalized scores
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-muted">No similarity scores available</p>
                            {% endif %}
                        </div>
                        
                        <div class="llm-validation">
                            <h6>LLM Validation:</h6>
                            {% if paper.get('llm_validation') %}
                                {% set llm_val = paper.llm_validation %}
                                <div class="llm-validation-summary">
                                    {% for topic in ['RLHF', 'Weak_supervision', 'Diffusion_reasoning', 'Distributed_training'] %}
                                        {% if llm_val.get(topic) %}
                                            {% set topic_data = llm_val[topic] %}
                                            <div class="llm-validation-item" data-topic="{{ topic }}">
                                                <span class="llm-topic-label">{{ topic.replace('_', ' ') }}:</span>
                                                {% if topic_data.get('validated', False) %}
                                                    {% if topic_data.get('llm_relevant', 'no') == 'yes' %}
                                                        <span class="llm-status llm-yes">YES</span>
                                                    {% else %}
                                                        <span class="llm-status llm-no">NO</span>
                                                    {% endif %}
                                                {% else %}
                                                    {% if topic_data.get('reason') == 'below_threshold' %}
                                                        <span class="llm-status llm-disabled">Below threshold</span>
                                                    {% else %}
                                                        <span class="llm-status llm-disabled">Not validated</span>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% set ns = namespace(has_justifications=false) %}
                                    {% for topic, topic_data in llm_val.items() %}
                                        {% if topic_data.get('validated', False) and topic_data.get('justification') %}
                                            {% set ns.has_justifications = true %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <div class="llm-buttons-row">
                                        <button class="btn btn-sm btn-outline-light llm-validation-toggle" 
                                                onclick="toggleLLMValidationDetails(this)" 
                                                data-paper-index="{{ loop.index0 }}">
                                            Show other topics ‚ñº
                                        </button>
                                        {% if ns.has_justifications %}
                                        <button class="btn btn-sm btn-outline-light llm-toggle" 
                                                onclick="toggleLLMDetails(this)" 
                                                data-paper-index="{{ loop.index0 }}">
                                            Show justifications ‚ñº
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    {% if ns.has_justifications %}
                                    <div class="llm-details" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                                        <h6 style="font-size: 0.9rem; margin-bottom: 0.5rem;">LLM Justifications:</h6>
                                        {% for topic, topic_data in llm_val.items() %}
                                            {% if topic_data.get('validated', False) and topic_data.get('justification') %}
                                            <div class="llm-justification">
                                                <strong>{{ topic.replace('_', ' ') }}:</strong> {{ topic_data.justification }}
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <p class="text-muted">No LLM validation data</p>
                            {% endif %}
                        </div>
                        
                        <div class="h-index-scores">
                            <h6>Author H-Index:</h6>
                            {% if paper.get('author_h_indices') and (paper.author_h_indices.get('success', False) or paper.author_h_indices.get('individual_h_indices')) %}
                                {% set h_indices = paper.author_h_indices %}
                                <div class="h-index-summary">
                                    <div class="h-index-metric">
                                        <span class="h-index-label">Data found:</span>
                                        <span class="h-index-value">{{ h_indices.get('authors_found_count', 0) }}/{{ h_indices.get('total_authors', 0) }} authors</span>
                                    </div>
                                    <div class="h-index-metric">
                                        <span class="h-index-label">H-index available:</span>
                                        <span class="h-index-value">{{ h_indices.get('authors_with_h_index_count', 0) }}/{{ h_indices.get('authors_found_count', 0) }} found</span>
                                    </div>
                                    <div class="h-index-metric">
                                        <span class="h-index-label">Highest:</span>
                                        <span class="h-index-value">{{ h_indices.get('highest_h_index') if h_indices.get('highest_h_index') is not none else 'N/A' }}</span>
                                    </div>
                                    <div class="h-index-metric">
                                        <span class="h-index-label">Average:</span>
                                        <span class="h-index-value">{{ h_indices.get('average_h_index') if h_indices.get('average_h_index') is not none else 'N/A' }}</span>
                                    </div>
                                    <div class="h-index-metric">
                                        <span class="h-index-label">Notable (H>5):</span>
                                        <span class="h-index-value">{{ h_indices.get('notable_authors_count', 0) }}</span>
                                    </div>
                                    <div class="h-index-metric">
                                        <span class="h-index-label">Source:</span>
                                        <span class="h-index-value">{{ h_indices.get('data_source', 'N/A') }}</span>
                                    </div>
                                    {% if h_indices.get('individual_h_indices') %}
                                    <div class="h-index-expand">
                                        <button class="btn btn-sm btn-outline-light h-index-toggle" 
                                                onclick="toggleHIndexDetails(this)" 
                                                data-paper-index="{{ loop.index0 }}">
                                            Show individual H-indices ‚ñº
                                        </button>
                                        <div class="h-index-details" style="display: none; margin-top: 0.5rem;">
                                            <h6 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Individual Author H-Indices:</h6>
                                            {% for author_h in h_indices.individual_h_indices %}
                                            <div class="individual-h-index">
                                                {% if author_h.get('profile_url') %}
                                                <a href="{{ author_h.get('profile_url') }}" target="_blank" class="author-name-link">
                                                    <span class="author-name">{{ author_h.get('name', 'Unknown') }}:</span>
                                                </a>
                                                {% else %}
                                                <span class="author-name">{{ author_h.get('name', 'Unknown') }}:</span>
                                                {% endif %}
                                                <span class="author-h-value">{{ author_h.get('h_index') if author_h.get('h_index') is not none else 'N/A' }}</span>
                                            </div>
                                            {% endfor %}
                                            {% if h_indices.get('paper_url') %}
                                            <div class="paper-verification" style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid #444;">
                                                <a href="{{ h_indices.get('paper_url') }}" target="_blank" class="paper-verification-link">
                                                    üîó Verify paper on Semantic Scholar
                                                </a>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <p class="text-muted">No H-index data available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Papers data for JavaScript processing
        const papers = {{ papers | tojson }};
        let filteredPapers = [...papers];
        
        // DOM elements
        const sortSelect = document.getElementById('sortBy');
        const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
        const llmFilterCheckboxes = document.querySelectorAll('.llm-filter-checkbox');
        const hIndexFilterCheckboxes = document.querySelectorAll('.h-index-filter-checkbox');
        const minScoreInput = document.getElementById('minScore');
        const maxScoreInput = document.getElementById('maxScore');
        const resetButton = document.getElementById('resetFilters');
        const papersContainer = document.getElementById('papers-container');
        const paperCountElement = document.getElementById('paper-count');
        const filterCountElement = document.getElementById('filter-count');
        
        // Get effective highest score for a paper based on selected topics
        function getEffectiveScore(paper, selectedTopics, minScore, maxScore) {
            if (!paper.scores) return 0;
            
            if (selectedTopics.length === 0) {
                // No topics selected, use overall highest score
                return paper.highest_score || 0;
            } else {
                // Topics selected, find highest score among selected topics that meet min/max threshold
                const selectedTopicScores = selectedTopics
                    .map(topic => paper.scores[topic] || 0)
                    .filter(score => score >= minScore && score <= maxScore);
                
                return selectedTopicScores.length > 0 ? Math.max(...selectedTopicScores) : 0;
            }
        }

        // Sort function
        function sortPapers(papers, sortBy, selectedTopics, minScore, maxScore) {
            return papers.sort((a, b) => {
                switch(sortBy) {
                    case 'overall_score_desc':
                        const overallA = a.scores_data?.overall_priority ?? 0;
                        const overallB = b.scores_data?.overall_priority ?? 0;
                        return overallB - overallA;
                    case 'overall_score_asc':
                        const overallA2 = a.scores_data?.overall_priority ?? 0;
                        const overallB2 = b.scores_data?.overall_priority ?? 0;
                        return overallA2 - overallB2;
                    case 'similarity_desc':
                        const scoreA = getEffectiveScore(a, selectedTopics, minScore, maxScore);
                        const scoreB = getEffectiveScore(b, selectedTopics, minScore, maxScore);
                        return scoreB - scoreA;
                    case 'similarity_asc':
                        const scoreA2 = getEffectiveScore(a, selectedTopics, minScore, maxScore);
                        const scoreB2 = getEffectiveScore(b, selectedTopics, minScore, maxScore);
                        return scoreA2 - scoreB2;
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'arxiv_id':
                        return (a.arxiv_id || '').localeCompare(b.arxiv_id || '');
                    case 'max_h_index_desc':
                        const maxHA = a.author_h_indices?.highest_h_index ?? -1;
                        const maxHB = b.author_h_indices?.highest_h_index ?? -1;
                        return maxHB - maxHA;
                    case 'max_h_index_asc':
                        const maxHA2 = a.author_h_indices?.highest_h_index ?? 999999;
                        const maxHB2 = b.author_h_indices?.highest_h_index ?? 999999;
                        return maxHA2 - maxHB2;
                    case 'avg_h_index_desc':
                        const avgHA = a.author_h_indices?.average_h_index ?? -1;
                        const avgHB = b.author_h_indices?.average_h_index ?? -1;
                        return avgHB - avgHA;
                    case 'avg_h_index_asc':
                        const avgHA2 = a.author_h_indices?.average_h_index ?? 999999;
                        const avgHB2 = b.author_h_indices?.average_h_index ?? 999999;
                        return avgHA2 - avgHB2;
                    default:
                        return 0;
                }
            });
        }
        
        // Get selected topics
        function getSelectedTopics() {
            return Array.from(topicCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }
        
        // Get selected LLM validation filters
        function getSelectedLLMFilters() {
            return Array.from(llmFilterCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }
        
        // Get selected H-Index filters
        function getSelectedHIndexFilters() {
            return Array.from(hIndexFilterCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        }
        
        // Check if paper meets LLM validation criteria
        function passesLLMValidation(paper, selectedTopics, selectedLLMFilters) {
            if (selectedLLMFilters.length === 0) return true; // No LLM filter applied
            
            const llmVal = paper.llm_validation;
            if (!llmVal) return false;
            
            // Determine which topics to check
            const topicsToCheck = selectedTopics.length > 0 ? selectedTopics : 
                ['RLHF', 'Weak_supervision', 'Diffusion_reasoning', 'Distributed_training'];
            
            // Check if any of the topics meet the LLM filter criteria
            return topicsToCheck.some(topic => {
                const topicData = llmVal[topic];
                if (!topicData) return false;
                
                return selectedLLMFilters.some(filter => {
                    switch(filter) {
                        case 'yes':
                            return topicData.validated && topicData.llm_relevant === 'yes';
                        case 'no':
                            return topicData.validated && topicData.llm_relevant === 'no';
                        case 'not_validated':
                            return !topicData.validated;
                        default:
                            return false;
                    }
                });
            });
        }
        
        // Check if paper meets H-Index criteria
        function passesHIndexValidation(paper, selectedHIndexFilters) {
            if (selectedHIndexFilters.length === 0) return true; // No H-Index filter applied
            
            const hIndices = paper.author_h_indices;
            if (!hIndices) {
                return selectedHIndexFilters.includes('none');
            }
            
            const totalAuthors = hIndices.total_authors || 0;
            const authorsWithHIndex = hIndices.authors_with_h_index_count || 0;
            
            return selectedHIndexFilters.some(filter => {
                switch(filter) {
                    case 'full':
                        return totalAuthors > 0 && authorsWithHIndex === totalAuthors;
                    case 'partial':
                        return authorsWithHIndex > 0 && authorsWithHIndex < totalAuthors;
                    case 'none':
                        return authorsWithHIndex === 0 || !hIndices.success;
                    default:
                        return false;
                }
            });
        }
        
        // Filter function with LLM validation and H-Index support
        function filterPapers(papers, selectedTopics, selectedLLMFilters, selectedHIndexFilters, minScore, maxScore) {
            return papers.filter(paper => {
                if (!paper.scores) return false;
                
                // Check if paper has at least one topic score within min/max range
                const validTopicScores = Object.entries(paper.scores)
                    .filter(([topic, score]) => score >= minScore && score <= maxScore);
                
                // If no topic scores meet the range, hide the paper
                if (validTopicScores.length === 0) {
                    return false;
                }
                
                // If specific topics are selected, check if paper has valid scores for those topics
                if (selectedTopics.length > 0) {
                    const hasValidSelectedTopic = selectedTopics.some(topic => 
                        paper.scores[topic] >= minScore && paper.scores[topic] <= maxScore
                    );
                    if (!hasValidSelectedTopic) {
                        return false;
                    }
                }
                
                // Check LLM validation filter
                if (!passesLLMValidation(paper, selectedTopics, selectedLLMFilters)) {
                    return false;
                }
                
                // Check H-Index validation filter
                if (!passesHIndexValidation(paper, selectedHIndexFilters)) {
                    return false;
                }
                
                return true;
            });
        }
        
        // Render papers
        function renderPapers() {
            const sortBy = sortSelect.value;
            const selectedTopics = getSelectedTopics();
            const selectedLLMFilters = getSelectedLLMFilters();
            const selectedHIndexFilters = getSelectedHIndexFilters();
            const minScore = parseFloat(minScoreInput.value) || 0;
            const maxScore = parseFloat(maxScoreInput.value) || 1;
            
            // Filter and sort
            filteredPapers = filterPapers([...papers], selectedTopics, selectedLLMFilters, selectedHIndexFilters, minScore, maxScore);
            filteredPapers = sortPapers(filteredPapers, sortBy, selectedTopics, minScore, maxScore);
            
            // Update paper count
            paperCountElement.textContent = `${filteredPapers.length} papers`;
            
            // Update filter count
            if (filterCountElement) {
                filterCountElement.textContent = `Showing ${filteredPapers.length}/${papers.length} papers`;
            }
            
            // Hide all paper cards first
            const paperCards = document.querySelectorAll('.paper-card');
            paperCards.forEach(card => card.classList.add('hidden'));
            
            // Create a document fragment to reorder the cards
            const fragment = document.createDocumentFragment();
            
            filteredPapers.forEach((paper, index) => {
                const originalIndex = papers.findIndex(p => p.arxiv_id === paper.arxiv_id);
                const card = document.querySelector(`[data-paper-index="${originalIndex}"]`);
                if (card) {
                    card.classList.remove('hidden');
                    // Update paper number
                    const numberElement = card.querySelector('.paper-number');
                    if (numberElement) {
                        numberElement.textContent = `#${index + 1}`;
                    }
                    
                    // Update similarity scores visibility and toggle state
                    updateTopicVisibility(card, selectedTopics, minScore, maxScore, 'similarity');
                    
                    // Update LLM validation visibility and toggle state  
                    updateTopicVisibility(card, selectedTopics, minScore, maxScore, 'llm-validation');
                    
                    // Add the card to the fragment in the correct order
                    fragment.appendChild(card);
                }
            });
            
            // Append the reordered cards back to the container
            papersContainer.appendChild(fragment);
        }
        
        // Function to update topic visibility based on filters
        function updateTopicVisibility(card, selectedTopics, minScore, maxScore, type) {
            if (type === 'similarity') {
                // Check if we're in normalized mode
                const summaryContainer = card.querySelector('.similarity-summary');
                const isNormalizedMode = summaryContainer && summaryContainer.classList.contains('normalized');
                
                // Skip filtering in normalized mode
                if (isNormalizedMode) {
                    return;
                }
                
                // Handle similarity scores with new grid structure
                const labels = card.querySelectorAll('.similarity-label');
                const rightColumns = card.querySelectorAll('.similarity-right-column');
                const content = card.querySelector('.similarity-scores-content');
                
                // Clear any existing separators first
                content.querySelectorAll('.topic-separator').forEach(sep => sep.remove());
                
                let totalValidTopics = 0;
                let currentlyVisibleTopics = 0;
                
                // First pass: determine what topics are valid (meet score criteria)
                const validTopics = [];
                labels.forEach((label, index) => {
                    const topic = label.getAttribute('data-topic');
                    const rightColumn = rightColumns[index];
                    const scoreElement = rightColumn.querySelector('.similarity-value');
                    const originalScore = parseFloat(scoreElement.getAttribute('data-original-score') || scoreElement.textContent);
                    
                    if (originalScore >= minScore && originalScore <= maxScore) {
                        validTopics.push({ topic, label, rightColumn, index });
                        totalValidTopics++;
                    } else {
                        // Hide invalid topics
                        label.style.display = 'none';
                        rightColumn.style.display = 'none';
                    }
                });
                
                // Second pass: show/hide valid topics based on selection
                validTopics.forEach(({ topic, label, rightColumn }) => {
                    const isSelected = selectedTopics.length === 0 || selectedTopics.includes(topic);
                    
                    if (isSelected) {
                        label.style.display = 'block';
                        rightColumn.style.display = 'flex';
                        currentlyVisibleTopics++;
                    } else {
                        label.style.display = 'none';
                        rightColumn.style.display = 'none';
                    }
                });
                
                // Update toggle button visibility
                const toggleButton = card.querySelector('.similarity-toggle');
                const normalizeButton = card.querySelector('.similarity-normalize-toggle');
                const toggleSection = card.querySelector('.similarity-toggle-section');
                if (toggleButton && toggleSection) {
                    // Show section if there are buttons to display
                    if (totalValidTopics > currentlyVisibleTopics || normalizeButton) {
                        toggleSection.style.display = 'flex';
                        if (totalValidTopics > currentlyVisibleTopics) {
                            toggleButton.style.display = 'inline-block';
                            toggleButton.textContent = 'Show other topics ‚ñº';
                        } else {
                            toggleButton.style.display = 'none';
                        }
                    } else {
                        toggleSection.style.display = 'none';
                    }
                }
            } else {
                // Handle LLM validation
                const items = card.querySelectorAll('.llm-validation-item');
                const content = card.querySelector('.llm-validation-summary');
                
                // Clear any existing separators first
                content.querySelectorAll('.topic-separator').forEach(sep => sep.remove());
                
                let totalTopics = items.length;
                let currentlyVisibleTopics = 0;
                
                items.forEach(item => {
                    const topic = item.getAttribute('data-topic');
                    const isSelected = selectedTopics.length === 0 || selectedTopics.includes(topic);
                    
                    if (isSelected) {
                        item.style.display = 'flex';
                        currentlyVisibleTopics++;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // Update toggle button visibility
                const toggleButton = card.querySelector('.llm-validation-toggle');
                const buttonsRow = card.querySelector('.llm-buttons-row');
                if (toggleButton && buttonsRow) {
                    const hasJustifications = card.querySelector('.llm-toggle');
                    
                    // Show buttons row if there are hidden topics OR justifications
                    if (totalTopics > currentlyVisibleTopics || hasJustifications) {
                        buttonsRow.style.display = 'flex';
                        toggleButton.style.display = (totalTopics > currentlyVisibleTopics) ? 'inline-block' : 'none';
                        if (totalTopics > currentlyVisibleTopics) {
                            toggleButton.textContent = 'Show other topics ‚ñº';
                        }
                    } else {
                        buttonsRow.style.display = 'none';
                    }
                }
            }
        }
        
        // Event listeners
        sortSelect.addEventListener('change', renderPapers);
        topicCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', renderPapers);
        });
        llmFilterCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', renderPapers);
        });
        hIndexFilterCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', renderPapers);
        });
        minScoreInput.addEventListener('input', renderPapers);
        maxScoreInput.addEventListener('input', renderPapers);
        
        resetButton.addEventListener('click', () => {
            sortSelect.value = 'overall_score_desc';
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            llmFilterCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            hIndexFilterCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            minScoreInput.value = '0';
            maxScoreInput.value = '1';
            renderPapers();
        });
        
        // Initial render
        renderPapers();
        
        // Normalized scores toggle functionality
        function toggleNormalizedScores(button) {
            const card = button.closest('.paper-card');
            const content = card.querySelector('.similarity-scores-content');
            const summaryContainer = card.querySelector('.similarity-summary');
            const currentMode = button.getAttribute('data-mode');
            const showHideButton = card.querySelector('.similarity-toggle');
            
            if (currentMode === 'raw') {
                // Switch to normalized mode
                switchToNormalizedMode(card, content, summaryContainer, button, showHideButton);
            } else {
                // Switch back to raw mode
                switchToRawMode(card, content, summaryContainer, button, showHideButton);
            }
        }
        
        function switchToNormalizedMode(card, content, summaryContainer, normalizeButton, showHideButton) {
            // 1. Show ALL topics and collect scores
            const allLabels = content.querySelectorAll('.similarity-label');
            const allRightColumns = content.querySelectorAll('.similarity-right-column');
            const allScores = [];
            
            // Collect all raw scores
            allLabels.forEach((label, index) => {
                const rightColumn = allRightColumns[index];
                const scoreElement = rightColumn.querySelector('.similarity-value');
                const originalScore = parseFloat(scoreElement.getAttribute('data-original-score'));
                allScores.push(originalScore);
                
                // Show all elements
                label.style.display = 'block';
                rightColumn.style.display = 'flex';
            });
            
            // 2. Calculate normalized scores with threshold
            const normalizedScores = calculateNormalizedScores(allScores);
            
            // 3. Update display
            allLabels.forEach((label, index) => {
                const rightColumn = allRightColumns[index];
                const scoreElement = rightColumn.querySelector('.similarity-value');
                const normalizedScore = normalizedScores[index];
                
                if (normalizedScore === 0) {
                    scoreElement.textContent = '0%';
                } else {
                    scoreElement.textContent = normalizedScore.toFixed(1) + '%';
                }
            });
            
            // 4. Update UI state
            summaryContainer.classList.add('normalized');
            normalizeButton.classList.add('active');
            normalizeButton.setAttribute('data-mode', 'normalized');
            normalizeButton.textContent = 'Show raw scores';
            
            // 5. Hide show/hide button
            if (showHideButton) {
                showHideButton.style.display = 'none';
            }
            
            // 6. Create topic separator like in expanded mode
            content.querySelectorAll('.topic-separator').forEach(sep => sep.remove());
            
            // Get current topic filters to determine selected vs non-selected
            const selectedTopics = getSelectedTopics();
            const selectedLabels = [];
            const nonSelectedLabels = [];
            
            allLabels.forEach((label, index) => {
                const topic = label.getAttribute('data-topic');
                const isSelected = selectedTopics.length === 0 || selectedTopics.includes(topic);
                if (isSelected) {
                    selectedLabels.push({ label, rightColumn: allRightColumns[index] });
                } else {
                    nonSelectedLabels.push({ label, rightColumn: allRightColumns[index] });
                }
            });
            
            // Add separator if there are both selected and non-selected topics
            if (selectedLabels.length > 0 && nonSelectedLabels.length > 0) {
                // Find the position to insert separator (after last selected topic)
                const lastSelectedIndex = Array.from(content.children).indexOf(selectedLabels[selectedLabels.length - 1].rightColumn);
                
                const separator = document.createElement('div');
                separator.className = 'topic-separator';
                separator.style.gridColumn = '1 / -1'; // Span both columns
                
                // Insert separator after the last selected topic
                if (lastSelectedIndex >= 0 && lastSelectedIndex + 1 < content.children.length) {
                    content.insertBefore(separator, content.children[lastSelectedIndex + 1]);
                }
            }
        }
        
        function switchToRawMode(card, content, summaryContainer, normalizeButton, showHideButton) {
            const allLabels = content.querySelectorAll('.similarity-label');
            const allRightColumns = content.querySelectorAll('.similarity-right-column');
            
            // 1. Restore original scores
            allLabels.forEach((label, index) => {
                const rightColumn = allRightColumns[index];
                const scoreElement = rightColumn.querySelector('.similarity-value');
                const originalScore = scoreElement.getAttribute('data-original-score');
                scoreElement.textContent = originalScore;
            });
            
            // 2. Update UI state
            summaryContainer.classList.remove('normalized');
            normalizeButton.classList.remove('active');
            normalizeButton.setAttribute('data-mode', 'raw');
            normalizeButton.textContent = 'Show normalized scores';
            
            // 3. Show show/hide button
            if (showHideButton) {
                showHideButton.style.display = 'inline-block';
            }
            
            // 4. Reapply current filters
            const selectedTopics = getSelectedTopics();
            const minScore = parseFloat(minScoreInput.value) || 0;
            const maxScore = parseFloat(maxScoreInput.value) || 1;
            updateTopicVisibility(card, selectedTopics, minScore, maxScore, 'similarity');
        }
        
        function calculateNormalizedScores(rawScores) {
            const MIN_SCORE_THRESHOLD = 0.25; // Based on data analysis
            const EPSILON = 1e-10; // Prevent division by zero
            
            // Step 1: Handle negative scores - clamp to 0
            const clampedScores = rawScores.map(score => Math.max(0, score));
            
            // Step 2: Apply minimum threshold - scores below 0.25 become 0
            const thresholdedScores = clampedScores.map(score => 
                score < MIN_SCORE_THRESHOLD ? 0 : score
            );
            
            // Step 3: Calculate sum with epsilon to prevent division by zero
            const sum = thresholdedScores.reduce((a, b) => a + b, 0) + EPSILON;
            
            // Step 4: Normalize only non-zero scores
            const normalizedScores = thresholdedScores.map(score => {
                if (score === 0) return 0;
                return (score / sum) * 100;
            });
            
            return normalizedScores;
        }
        
        // Similarity scores toggle functionality
        function toggleSimilarityDetails(button) {
            const card = button.closest('.paper-card');
            const content = card.querySelector('.similarity-scores-content');
            const summaryContainer = card.querySelector('.similarity-summary');
            
            // Don't allow toggling in normalized mode
            if (summaryContainer && summaryContainer.classList.contains('normalized')) {
                return;
            }
            
            const selectedTopics = getSelectedTopics();
            const minScore = parseFloat(minScoreInput.value) || 0;
            const maxScore = parseFloat(maxScoreInput.value) || 1;
            
            const allLabels = content.querySelectorAll('.similarity-label');
            const allRightColumns = content.querySelectorAll('.similarity-right-column');
            const isExpanded = button.textContent.includes('Hide');
            
            // Remove any existing separators
            content.querySelectorAll('.topic-separator').forEach(sep => sep.remove());
            
            if (isExpanded) {
                // Collapse - show only selected topics (or all if none selected)
                allLabels.forEach((label, index) => {
                    const topic = label.getAttribute('data-topic');
                    const rightColumn = allRightColumns[index];
                    const scoreElement = rightColumn.querySelector('.similarity-value');
                    const scoreValue = parseFloat(scoreElement.getAttribute('data-original-score') || scoreElement.textContent);
                    
                    // Skip topics that don't meet score criteria
                    if (scoreValue < minScore || scoreValue > maxScore) {
                        label.style.display = 'none';
                        rightColumn.style.display = 'none';
                        return;
                    }
                    
                    // Show only selected topics (or all if none selected)
                    const isSelected = selectedTopics.length === 0 || selectedTopics.includes(topic);
                    if (isSelected) {
                        label.style.display = 'block';
                        rightColumn.style.display = 'flex';
                    } else {
                        label.style.display = 'none';
                        rightColumn.style.display = 'none';
                    }
                });
                button.textContent = 'Show other topics ‚ñº';
            } else {
                // Expand - show selected topics first, then separator, then non-selected topics
                
                // Collect all valid topics with their data
                const validTopics = [];
                allLabels.forEach((label, index) => {
                    const topic = label.getAttribute('data-topic');
                    const rightColumn = allRightColumns[index];
                    const scoreElement = rightColumn.querySelector('.similarity-value');
                    const scoreValue = parseFloat(scoreElement.getAttribute('data-original-score') || scoreElement.textContent);
                    
                    if (scoreValue >= minScore && scoreValue <= maxScore) {
                        const isSelected = selectedTopics.length === 0 || selectedTopics.includes(topic);
                        validTopics.push({
                            topic,
                            label,
                            rightColumn,
                            index,
                            isSelected,
                            scoreValue
                        });
                    }
                });
                
                // Separate selected and non-selected topics (preserve original order within each group)
                const selectedValidTopics = validTopics.filter(t => t.isSelected);
                const nonSelectedValidTopics = validTopics.filter(t => !t.isSelected);
                
                // Clear the content and rebuild it in the correct order
                content.innerHTML = '';
                
                // Add selected topics first
                selectedValidTopics.forEach(({ topic, scoreValue }) => {
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'similarity-label';
                    labelSpan.setAttribute('data-topic', topic);
                    labelSpan.textContent = topic.replace('_', ' ') + ':';
                    
                    const rightDiv = document.createElement('div');
                    rightDiv.className = 'similarity-right-column';
                    rightDiv.setAttribute('data-topic', topic);
                    
                    const barDiv = document.createElement('div');
                    barDiv.className = 'similarity-bar';
                    
                    const fillDiv = document.createElement('div');
                    fillDiv.className = 'similarity-bar-fill';
                    fillDiv.style.width = `${(scoreValue * 100).toFixed(1)}%`;
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'similarity-value';
                    valueSpan.setAttribute('data-original-score', scoreValue.toFixed(3));
                    valueSpan.textContent = scoreValue.toFixed(3);
                    
                    barDiv.appendChild(fillDiv);
                    rightDiv.appendChild(barDiv);
                    rightDiv.appendChild(valueSpan);
                    
                    content.appendChild(labelSpan);
                    content.appendChild(rightDiv);
                });
                
                // Add separator if there are both selected and non-selected topics
                if (selectedValidTopics.length > 0 && nonSelectedValidTopics.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'topic-separator';
                    separator.style.gridColumn = '1 / -1'; // Span both columns
                    content.appendChild(separator);
                }
                
                // Add non-selected topics after separator
                nonSelectedValidTopics.forEach(({ topic, scoreValue }) => {
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'similarity-label';
                    labelSpan.setAttribute('data-topic', topic);
                    labelSpan.textContent = topic.replace('_', ' ') + ':';
                    
                    const rightDiv = document.createElement('div');
                    rightDiv.className = 'similarity-right-column';
                    rightDiv.setAttribute('data-topic', topic);
                    
                    const barDiv = document.createElement('div');
                    barDiv.className = 'similarity-bar';
                    
                    const fillDiv = document.createElement('div');
                    fillDiv.className = 'similarity-bar-fill';
                    fillDiv.style.width = `${(scoreValue * 100).toFixed(1)}%`;
                    
                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'similarity-value';
                    valueSpan.setAttribute('data-original-score', scoreValue.toFixed(3));
                    valueSpan.textContent = scoreValue.toFixed(3);
                    
                    barDiv.appendChild(fillDiv);
                    rightDiv.appendChild(barDiv);
                    rightDiv.appendChild(valueSpan);
                    
                    content.appendChild(labelSpan);
                    content.appendChild(rightDiv);
                });
                
                button.textContent = 'Hide other topics ‚ñ≤';
            }
        }
        
        // LLM validation toggle functionality  
        function toggleLLMValidationDetails(button) {
            const card = button.closest('.paper-card');
            const content = card.querySelector('.llm-validation-summary');
            const selectedTopics = getSelectedTopics();
            
            const allItems = content.querySelectorAll('.llm-validation-item');
            const isExpanded = button.textContent.includes('Hide');
            
            // Remove any existing separators
            content.querySelectorAll('.topic-separator').forEach(sep => sep.remove());
            
            if (isExpanded) {
                // Collapse - show only selected topics (or all if none selected)
                allItems.forEach(item => {
                    const topic = item.getAttribute('data-topic');
                    const isSelected = selectedTopics.length === 0 || selectedTopics.includes(topic);
                    
                    if (isSelected) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
                button.textContent = 'Show other topics ‚ñº';
            } else {
                // Expand - show selected topics first, then separator, then non-selected topics
                
                // Collect all topics with their data
                const allTopics = [];
                allItems.forEach((item, index) => {
                    const topic = item.getAttribute('data-topic');
                    const isSelected = selectedTopics.length === 0 || selectedTopics.includes(topic);
                    const topicLabel = item.querySelector('.llm-topic-label').textContent;
                    const statusElement = item.querySelector('.llm-status');
                    const statusText = statusElement.textContent;
                    const statusClass = statusElement.className;
                    
                    allTopics.push({
                        topic,
                        item,
                        index,
                        isSelected,
                        topicLabel,
                        statusText,
                        statusClass
                    });
                });
                
                // Separate selected and non-selected topics (preserve original order within each group)
                const selectedTopics_items = allTopics.filter(t => t.isSelected);
                const nonSelectedTopics_items = allTopics.filter(t => !t.isSelected);
                
                // Remove only the topic items, preserve buttons and details
                const buttonsRow = content.querySelector('.llm-buttons-row');
                const llmDetails = content.querySelector('.llm-details');
                
                // Remove all topic items
                const topicItems = content.querySelectorAll('.llm-validation-item');
                topicItems.forEach(item => item.remove());
                
                // Remove any existing separators
                const separators = content.querySelectorAll('.topic-separator');
                separators.forEach(sep => sep.remove());
                
                // Add selected topics first
                selectedTopics_items.forEach(({ topic, topicLabel, statusText, statusClass }) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'llm-validation-item';
                    itemDiv.setAttribute('data-topic', topic);
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'llm-topic-label';
                    labelSpan.textContent = topicLabel;
                    
                    const statusSpan = document.createElement('span');
                    statusSpan.className = statusClass;
                    statusSpan.textContent = statusText;
                    
                    itemDiv.appendChild(labelSpan);
                    itemDiv.appendChild(statusSpan);
                    
                    // Insert before buttons row if it exists, otherwise just append
                    if (buttonsRow) {
                        content.insertBefore(itemDiv, buttonsRow);
                    } else {
                        content.appendChild(itemDiv);
                    }
                });
                
                // Add separator if there are both selected and non-selected topics
                if (selectedTopics_items.length > 0 && nonSelectedTopics_items.length > 0) {
                    const separator = document.createElement('div');
                    separator.className = 'topic-separator';
                    
                    // Insert before buttons row if it exists, otherwise just append
                    if (buttonsRow) {
                        content.insertBefore(separator, buttonsRow);
                    } else {
                        content.appendChild(separator);
                    }
                }
                
                // Add non-selected topics after separator
                nonSelectedTopics_items.forEach(({ topic, topicLabel, statusText, statusClass }) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'llm-validation-item';
                    itemDiv.setAttribute('data-topic', topic);
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'llm-topic-label';
                    labelSpan.textContent = topicLabel;
                    
                    const statusSpan = document.createElement('span');
                    statusSpan.className = statusClass;
                    statusSpan.textContent = statusText;
                    
                    itemDiv.appendChild(labelSpan);
                    itemDiv.appendChild(statusSpan);
                    
                    // Insert before buttons row if it exists, otherwise just append
                    if (buttonsRow) {
                        content.insertBefore(itemDiv, buttonsRow);
                    } else {
                        content.appendChild(itemDiv);
                    }
                });
                
                button.textContent = 'Hide other topics ‚ñ≤';
            }
        }
        
        // H-index toggle functionality
        function toggleHIndexDetails(button) {
            const details = button.parentNode.querySelector('.h-index-details');
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
                button.textContent = 'Hide individual H-indices ‚ñ≤';
            } else {
                details.style.display = 'none';
                button.textContent = 'Show individual H-indices ‚ñº';
            }
        }
        
        // LLM justification toggle functionality
        function toggleLLMDetails(button) {
            const card = button.closest('.paper-card');
            const details = card.querySelector('.llm-details');
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
                button.textContent = 'Hide justifications ‚ñ≤';
            } else {
                details.style.display = 'none';
                button.textContent = 'Show justifications ‚ñº';
            }
        }
    </script>
    
    <!-- KaTeX auto-render initialization -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false,
                errorColor: 'inherit',
                strict: false,
                trust: false
            });
        });
    </script>
</body>
</html> 