# This is a GitHub Actions workflow file that defines a set of automated tasks.
# It's written in YAML, a human-readable data serialization language.

name: run data pipeline # The name of the workflow, which will be displayed on GitHub.

# This section defines when the workflow should be triggered.
on:
  # Allows the workflow to be run manually from the Actions tab in your GitHub repository.
  workflow_dispatch:
    inputs:
      test_run:
        description: 'Perform a test run using test_papers.txt'
        required: true
        default: false
        type: boolean
      paper_date:
        description: 'Date of papers to process (YYYY-MM-DD format)'
        required: true
        default: '2025-07-01'
        type: string
  # Triggers the workflow on a schedule - daily at 7:00 AM SGT (which is 23:00 UTC the previous day)
  schedule:
    - cron: '0 23 * * *'

# This section grants the necessary permissions to the GITHUB_TOKEN for the jobs.
permissions:
  contents: write # Allows the workflow to read and write repository content.

# This section defines the jobs that will be executed as part of the workflow.
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r pipeline/requirements.txt

      - name: Calculate date 20 days ago
        id: calculate_date
        run: |
          CALCULATED_DATE=$(date -d "20 days ago" +%Y-%m-%d)
          echo "calculated_date=$CALCULATED_DATE" >> $GITHUB_OUTPUT
          echo "Calculated date (20 days ago): $CALCULATED_DATE"

      - name: Run script in test mode
        if: github.event.inputs.test_run == 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd pipeline
          python src/main.py --test test_papers.txt

      - name: Run data pipeline
        if: github.event.inputs.test_run != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PAPER_DATE: ${{ github.event.inputs.paper_date || steps.calculate_date.outputs.calculated_date }}
        run: |
          cd pipeline
          echo "Running pipeline for date: $PAPER_DATE"
          python src/main.py --date=$PAPER_DATE

      - name: Check database size
        run: |
          echo "Checking database size:"
          ls -lh pipeline/database.sqlite
          echo "Checking logs directory:"
          du -sh pipeline/logs

      - name: Commit and push changes to main branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pipeline/database.sqlite pipeline/logs/
          git commit -m "Update database $(date +%Y-%m-%d)" || exit 0
          git push